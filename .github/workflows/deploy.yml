name: Deploy to DigitalOcean

on:
    push:
        branches: ["main"]

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Start SSH agent and add key
          uses: webfactory/ssh-agent@v0.9.0
          with: 
            ssh-private-key: ${{ secrets.DO_SSH_KEY }}

        - name: Add server to known hosts
          run: |
            mkdir -p ~/.ssh
            ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts
        
        - name: Deploy files to server
          run: |
            rsync -az --delete \
              --exclude ".git" \ 
              --exclude ".github" \
              "$GITHUB_WORKSPACE/" \
              ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/var/www/khoale.site/